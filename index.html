<!doctype html>
<html lang="en">

	<head>
		<meta charset="utf-8">

		<title>Music Videos in R</title>

		<meta name="description" content="Presenting high-dimensional data in a web browser">
		<meta name="author" content="Thomas Levine">

		<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<link rel="stylesheet" href="css/reveal.min.css">
		<link rel="stylesheet" href="css/theme/sky.css" id="theme">

		<!-- For syntax highlighting -->
		<link rel="stylesheet" href="lib/css/zenburn.css">

		<!-- If the query includes 'print-pdf', use the PDF print sheet -->
		<script>
			document.write( '<link rel="stylesheet" href="css/print/' + ( window.location.search.match( /print-pdf/gi ) ? 'pdf' : 'paper' ) + '.css" type="text/css" media="print">' );
		</script>

		<!--[if lt IE 9]>
		<script src="lib/js/html5shiv.js"></script>
		<![endif]-->
	</head>

	<body>

		<div class="reveal">

			<!-- Any section element inside of this container is displayed as a slide -->
			<div class="slides">

				<section>
					<h1>Music Videos in R</h1>
					<h3>Presenting high-dimensional data in a web browser</h3>
					<p>
						<small><a href="http://thomaslevine.com">Thomas Levine</a></small>
					</p>
					<p>
						<small><a href="http://csvsoundsystem.com">CSV Soundsystem</a></small>
					</p>
				</section>

				<section>
                    <h2>Big Data</h2>
				</section>

				<section>
                    <h3>Static images are limited</h3>
                    <img src="minard.png" alt="Minard's map of Napoleon's march" />
                    <!-- http://upload.wikimedia.org/wikipedia/commons/2/29/Minard.png -->
				</section>

				<section>
                    <h3>Wide audience</h3>
                    <img src="html5-logo.png" alt="HTML5 logo" />
                    <!-- http://upload.wikimedia.org/wikipedia/commons/thumb/6/6e/HTML5-logo.svg/500px-HTML5-logo.svg.png -->
                </section>

				<section>
                    <h4>Vision</h4>
                    <img src="eye.jpg" alt="Closeup of the eye of a Red-tailed Hawk (Buteo jamaicensis)." />
                    <!-- http://upload.wikimedia.org/wikipedia/commons/3/3e/Hawk_eye.jpg -->
                </section>

				<section>
                    <h4>Hearing</h4>
                    <img src="ear.jpg" alt="A human ear" />
                    <!-- http://upload.wikimedia.org/wikipedia/commons/1/1d/Earrr.JPG -->
                </section>

                <section>
                    <h4>Touch</h4>
                    <pre><code>navigator.vibrate([1000, 500, 2000])</code></pre>
                    <a href="http://www.w3.org/TR/vibration/">HTML vibration API</a>
                </section>

				<section>
                    <h3>Side benefits</h3>
                </section>

                <section>
                    <h4>Accessibility</h4>
                    <img src="open-doors.jpg" alt="&quot;Opening Doors to IT&quot; logo" />
                    <!-- http://www.section508.gov/images/open_doors_seal-b.jpg -->
                    <br />
                    <ul>
                        <li><a href="https://www.section508.gov/">Section 508</a></li>
                        <li><a href="http://www.w3.org/TR/WCAG10/">Web Content Accessibility Guidelines</a></li>
                    </ul>
                </section>

				<section>
					<h4>Reaching young people</h4>
                    <iframe width="560" height="315" src="http://www.youtube.com/embed/JwuEnyV1Cb0" frameborder="0" allowfullscreen></iframe>
				</section>

				<section>
                    <h3>Why use R?</h3>
                    <img src="r.jpg" alt="R logo" />
                    <!-- http://www.r-project.org/Rlogo.jpg -->
				</section>

				<section>
                    <h3>Vector graphics</h3>
                    <p>A plot goes here.</p>
				</section>

                <section>
                    <h3>CSV Soundsystem</h3>
                    <p>Sound waves go here.</p>
				</section>

                <section>
                    <h3>Data</h3>
                    <pre><code>str(iris)
'data.frame':   150 obs. of  5 variables:
 $ Sepal.Length: num  5.1 4.9 4.7 4.6 5 5.4 4.6 5 4.4 4.9 ...
 $ Sepal.Width : num  3.5 3 3.2 3.1 3.6 3.9 3.4 3.4 2.9 3.1 ...
 $ Petal.Length: num  1.4 1.4 1.3 1.5 1.4 1.7 1.4 1.5 1.4 1.5 ...
 $ Petal.Width : num  0.2 0.2 0.2 0.2 0.2 0.4 0.3 0.2 0.2 0.1 ...
 $ Species     : Factor w/ 3 levels "setosa","versicolor",..: 1 1 1 1 1 1 1 1 1 1 ...</code></pre>
				</section>

                <section>
                    <h2>Two case studies</h2>
				</section>

                <section>
                    <h3>Christmas Gifts</h3>
                    <iframe width="560" height="315" src="http://www.youtube.com/watch?v=rLZDvXPIDa0" frameborder="0" allowfullscreen></iframe>
				</section>

                <section>
                    <p>Walk through the code</p>
				</section>

                <section>
                    <h3>Federal spending</h3>
                    <!-- <iframe width="100%" height="100%" src="http://fms.csvsoundsystem.com" frameborder="0" allowfullscreen></iframe>
                    <iframe width="960px" height="100%" src="file:///home/tlevine/Documents/fms-symphony/index.html" frameborder="0" allowfullscreen></iframe> -->
                    <a href="http://fms.csvsoundsystem.com"><img src="fms.png" alt="FMS Symphony" /></a>
				</section>

                <section>
                    <h3>Fed spending</h3>
                    <ol>
                        <li>Download fixies from the FMS site, and convert them into CSV</li>
                        <li>Load into R, and produce the audio and video tracks</li>
                        <ol>
                            <li>Generate 1877 plots, one per frame.</li>
                            <li>Generate a song.</li>
                        </ol>
                        <li>Combine the frames and the song in a website</li>
                    </ol>
				</section>

				<section>
                    <h4>Video</h4>
                    <img src="annotated-screenshot.png" alt="Annotated screenshot of the video" />
                </section>

				<section>
                    <h5>The part that we generate in R</h5>
                    <img src="file:///home/tlevine/Documents/fms-symphony/slideshow/1028.png" alt="A frame from the video, generated in R" />
                </section>

				<section>
                    <h5>Overview: The main function</h5>
                    <pre><code>
main.plots <- function() {
    for (i in 1:nrow(table2.toplot)) {
         png(sprintf('slideshow/%d.png', i), width = 1200, height = 600) 
         frame(i)
         dev.off()
    }
}
</pre></code>
                    <p>Now we'll walk through the code, glossing over the sections that are less specific to music videos.</p>
				</section>

				<section>
                    <h5>Libraries</h5>
                    <p>Libraries</p>
                    <pre><code>
library(plyr)
library(aplpack) # Cheroff faces
library(reshape2)
</code></pre>
				</section>

				<section>
                    <h5>Video</h5>
                    <p>Munge</p>
                    <pre><code>
# Load the data
if (!'table2.raw' %in% ls()) {
    table2.raw <- read.csv('table2-std.csv')

    # Fix types
    table2.raw$date <- as.Date(table2.raw$date)
    table2.raw$type <- factor(table2.raw$type)
    table2.raw$item <- factor(table2.raw$item)
    table2.raw$today <- as.numeric(table2.raw$today)

    source('data.r')
    fed.rate <- read.csv('fed_rate.csv', stringsAsFactors = F)
    fed.rate$date <- strptime(fed.rate$date, format = '%m/%d/%y')
}
table2 <- table2.raw[!table2.raw$is_total,c('date', 'type', 'item', 'today')]

# Select only the items that are present on all days.
n.days <- length(unique(table2$date))
table2.pca <- ddply(table2, c('type', 'item'), function(df) {
    if (nrow(df) == n.days) {
        df
    }
})
</code></pre>
				</section>

				<section>
                    <h5>Video</h5>
                    <pre><code>
# Run PCA
items <- dcast(table2.pca, date ~ type + item, value.var = 'today')[-1]
pca <- princomp(items, cor = T)
pca.stuff <- function() {
    summary(pca)
    plot(pca$sdev ~ I(1:length(pca$sdev)))
}
factored <- t(scale(items, center = pca$center, scale = pca$scale) %*% pca$loadings)
</code></pre>
				</section>

				<section>
                    <h5>Video</h5>
                    <p>Generate all 1877 faces. This takes some time.</p>
                    <pre><code>
# Make faces
f.all <- faces(t(factored)[,1:15], plot = F, print.info = F)
</code></pre>
				</section>

                <section data-state="alert">
                    <h5>Problem with <code>aplpack</code></h5>
                    <p>Plotting this could take a while.</p>
                    <img src="18faces.png" alt="Plot of 18 faces generated by aplpack" />
				</section>

				<section data-state="soothe">
                    <h5>Plot optimization hack</h5>
                    <pre><code>
# Plot a Chernoff face for a day at an x, y
face <- function(day.or.days, x, y, ...) {
    # day.or.days is a row index

    f <- f.all
    f$xy <- f$faces <- NULL

    f$xy <- matrix(f.all$xy[,day.or.days])
    dimnames(f$xy) <- dimnames(f.all$xy)
    f$faces <-f.all$faces[day.or.days]

    x.pos <- x + abs(diff(range(table2.toplot$date)) / 20)

    plot.faces(f, face.type = 1, x.pos = x.pos, y.pos = y, ...)
}

</code></pre>
				</section>

				<section>
                    <h5>Dunno what this does</h5>
                    <pre><code>
# Other plot stuff
table2.tmp <- ddply(table2.pca, 'date', function(df) { c(error = sd(df$today)) })
table2.toplot <- join(join(table2.tmp, fms.day[c('date', 'balance')]), fed.rate)
</code></pre>
				</section>

				<section>
                    <h5>More munging</h5>
                    <pre><code>
# Remove NAs
table2.toplot[c(358, 833, 1022, 1393, 1398),] <- table2.toplot[c(358, 833, 1022, 1393, 1398) - 1,]

# Skip the top 40 for rolling.
table2.toplot <- table2.toplot[-(1:40),]
</code></pre>
				</section>

				<section>
                    <h5>Colors</h5>
                    <pre><code>
# Video frame
bg.of.week <- c(
  Sunday = '#DDDDDD',
  Monday = '#FFDDDD',
  Tuesday = '#DDFFDD',
  Wednesday = '#DDDDFF',
  Thursday = '#DDFFFF',
  Friday = '#FFFFDD',
  Saturday = '#FFDDFF'
)
fg.of.week <- c(
  Sunday = '#000000',
  Monday = '#00DDDD',
  Tuesday = '#DDDD00',
  Wednesday = '#DD00DD',
  Thursday = '#DD0000',
  Friday = '#00DD00',
  Saturday = '#0000DD'
)
</code></pre>
				</section>

				<section>
                    <h5>Plot one frame</h5>
                    <pre><code>
frame <- function(i) {
    if (i <= 2) {
        return
    }
    day.of.week.a <- strftime(table2.toplot[i,'date'], format = '%A')
    bg <- bg.of.week[day.of.week.a][[1]]
    fg <- fg.of.week[day.of.week.a][[1]]
    par(
        bg = bg
    )
    plot(
        table2.toplot[1:i,'balance'] ~ table2.toplot[1:i,'date'],
        type = 'n',
        xlim = range(table2.toplot$date),
        ylim = c(-2e5, 7e5), #range(table2.toplot$balance),
        xlab = '', #Date
        ylab = 'Cash in the bank (billions)', main = '', #'FMS Soundsystem',
        axes = F, col = 4 # so we notice errors
    )
    abline(h = 0, col = fg)

    # Rate
    #range(table2.toplot$balance)

    # Balance
    polygon(
        c(table2.toplot[1:i,'date'], table2.toplot[i:1,'date']),
        c(table2.toplot[1:i,'balance'], table2.toplot[i:1,'balance']) + c(table2.toplot[1:i,'error'], - table2.toplot[i:1,'error']),
        col = 1
    )

    # Under balance
    rect(
        xright =  min(table2.toplot$date),
        ybottom = mean(range(table2.toplot$balance)) * 0.95,
        xleft =   weighted.mean(range(table2.toplot$date), c(18, 3)),
        ytop    = mean(range(table2.toplot$balance)) * 1.15,
        col = 1
    )
    text(
        x = min(table2.toplot$date),
        y = mean(range(table2.toplot$balance)) * c(1.1, 1),
        labels = c(
            'Balance',
            sub('\\$-', '-$', paste('$', as.character(round(table2.toplot[i,'balance'] / 1000)), ' billion', sep = ''))
        ),
        pos = 4, font = 2:1, col = fg
    )

    # Under interest rate
    rect(
        xleft =   weighted.mean(range(table2.toplot$date), c(3, 18)),
        ybottom = mean(range(table2.toplot$balance)) * 0.95,
        xright =  max(table2.toplot$date),
        ytop    = mean(range(table2.toplot$balance)) * 1.15,
        col = 1
    )
    text(
        x = max(table2.toplot$date),
        y = mean(range(table2.toplot$balance)) * c(1.1, 1),
        labels = c(
            'Interest rate',
            sub('\\$-', '-$', paste('$', as.character(round(table2.toplot[i,'balance'] / 1000)), ' billion', sep = ''))
        ),
        pos = 2, font = 2:1, col = fg
    )

    # Under main
    rect(
        xleft   = weighted.mean(range(table2.toplot$date), c(2, 9)),
        ybottom = weighted.mean(range(table2.toplot$balance), c(2, 15)),
        xright  = max(table2.toplot$date),
        ytop    = max(table2.toplot$balance),
        col = 1
    )
    text(
        x = weighted.mean(range(table2.toplot$date), c(1, 9)),
        y = c(
            weighted.mean(range(table2.toplot$balance), c(1, 15)),
            weighted.mean(range(table2.toplot$balance), c(2, 15))
        ),
        labels = c(
            'FMS Soundsystem',
            strftime(table2.toplot[i,'date'], format = '%B %Y')
        ),
        col = fg, pos = 3, font = 2:1
    )

    ticks <- seq(-2e5, 6e5, 1e5)
    axis(2, at = ticks, labels = round(ticks / 1000))
    face(i,
        x = table2.toplot[i,'date'],
        y = table2.toplot[i,'balance'],
        height = abs(diff(range(table2.toplot$balance))) / 5,
        width = abs(diff(range(table2.toplot$date))) / 10,
        labels = ''
    )

    par(new = T)
    plot(
         table2.toplot[1:i,'rate'] ~ table2.toplot[1:i,'date'],
         axes = F, xlab = '', ylab = '', type = 'l', lty = 2,
         xlim = range(table2.toplot$date), ylim = c(-2, max(table2.toplot$rate))
    )
    mtext("Federal interest rate", side=4, line=3)
    axis(4, at = 0:5, labels = paste(0:5, '%', sep = ''), lty = 2)
}
</code></pre>
				</section>

				<section data-state="blackout">
                    <h5>Plot one frame: How to use</h5>
                    <pre><code>
# Plot the 30th frame.
frame(30)
</code></pre>
				</section>

				<section>
                <h5><code>type="n"</code></h5>
                    <pre><code>
    plot(
        table2.toplot[1:i,'balance'] ~ table2.toplot[1:i,'date'],
        type = 'n',
        xlim = range(table2.toplot$date),
        ylim = c(-2e5, 7e5), #range(table2.toplot$balance),
        xlab = '', #Date
        ylab = 'Cash in the bank (billions)', main = '', #'FMS Soundsystem',
        axes = F, col = 4 # so we notice errors
    )
</code></pre>
				</section>

				<section>
                    <h5>Confidence interval with <code>polygon</code></h5>
                    <pre><code>
    # Balance
    polygon(
        c(table2.toplot[1:i,'date'], table2.toplot[i:1,'date']),
        c(table2.toplot[1:i,'balance'], table2.toplot[i:1,'balance']) + c(table2.toplot[1:i,'error'], - table2.toplot[i:1,'error']),
        col = 1
    )
</code></pre>
				</section>

				<section>
                    <h5>More arguments to <code>plot</code></h5>
                    <pre><code>
    par(new = T)
    plot(
         table2.toplot[1:i,'rate'] ~ table2.toplot[1:i,'date'],
         axes = F, xlab = '', ylab = '', type = 'l', lty = 2,
         xlim = range(table2.toplot$date), ylim = c(-2, max(table2.toplot$rate))
    )
    mtext("Federal interest rate", side=4, line=3)
    axis(4, at = 0:5, labels = paste(0:5, '%', sep = ''), lty = 2)
</code></pre>
				</section>

				<section>
                    <h5>Plot one frame: interesting bits</h5>
                    <pre><code>
</code></pre>
				</section>

				<section>
                    <h5>Plot one frame: interesting bits</h5>
                    <pre><code>
</code></pre>
				</section>

				<section>
                    <h5></h5>
                    <pre><code>
</code></pre>
				</section>

				<section>
                    <h5>Things to remember</h5>
                    <ul>
                        <li>Base R graphics are powerful.</li>
                        <li><code>locator</code> is helpful.</li>
                        <li><strong>Use ggplot</strong> if you don't need this level of control.</li>
                    </ul>
				</section>

                <section>
				</section>

                <section>
                    <h2>CSV Soundsystem library</h2>
				</section>

				<section>
					<section data-state="alert">
						<h2>Global State</h2>
						<p>
							Set <code>data-state="something"</code> on a slide and <code>"something"</code>
							will be added as a class to the document element when the slide is open. This lets you
							apply broader style changes, like switching the background.
						</p>
						<a href="#" class="image navigate-down">
							<img width="178" height="238" src="https://s3.amazonaws.com/hakim-static/reveal-js/arrow.png" alt="Down arrow">
						</a>
					</section>
					<section data-state="blackout">
						<h2>"blackout"</h2>
						<a href="#" class="image navigate-down">
							<img width="178" height="238" src="https://s3.amazonaws.com/hakim-static/reveal-js/arrow.png" alt="Down arrow">
						</a>
					</section>
					<section data-state="soothe">
						<h2>"soothe"</h2>
						<a href="#" class="image navigate-next">
							<img width="178" height="238" src="https://s3.amazonaws.com/hakim-static/reveal-js/arrow.png" alt="Up arrow" style="-webkit-transform: rotate(-90deg);">
						</a>
					</section>
				</section>
				<section>
					<h2>Export to PDF</h2>
					<p>Presentations can be <a href="https://github.com/hakimel/reveal.js#pdf-export">exported to PDF</a>, below is an example that's been uploaded to SlideShare.</p>
					<iframe id="slideshare" src="http://www.slideshare.net/slideshow/embed_code/13872948" width="455" height="356" style="margin:0;overflow:hidden;border:1px solid #CCC;border-width:1px 1px 0;margin-bottom:5px" allowfullscreen> </iframe>
					<script>
						document.getElementById('slideshare').attributeName = 'allowfullscreen';
					</script>
				</section>
			</div>
		</div>

		<script src="lib/js/head.min.js"></script>
		<script src="js/reveal.min.js"></script>

		<script>

			// Full list of configuration options available here:
			// https://github.com/hakimel/reveal.js#configuration
			Reveal.initialize({
				controls: true,
				progress: true,
				history: true,
				center: true,

				theme: Reveal.getQueryHash().theme, // available themes are in /css/theme
				transition: Reveal.getQueryHash().transition || 'none', // default/cube/page/concave/zoom/linear/fade/none

				// Optional libraries used to extend on reveal.js
				dependencies: [
					{ src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
					{ src: 'plugin/markdown/showdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
					{ src: 'plugin/zoom-js/zoom.js', async: true, condition: function() { return !!document.body.classList; } },
					{ src: 'plugin/notes/notes.js', async: true, condition: function() { return !!document.body.classList; } }
					// { src: 'plugin/remotes/remotes.js', async: true, condition: function() { return !!document.body.classList; } }
				]
			});

		</script>

	</body>
</html>
